---
title: "Lloyd 2016 DR Birds: Both Locations GLMM"
author: "brouwern@gmail.com"
date: "February 20, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




#Data setup

## Load Lloyd data

```{r}
setwd("C:/Users/lisanjie2/Dropbox/Scott_E_Aviary_Projects")

dat <- read.csv(file = "Lloyd_PeerJ2916_for_regression_2_16_2017.csv")
```



## Load spp info

* skip = 7 skips the 7 rows of header info in this fiel
```{r}
spp.info <- read.csv(file = "Latta_Lloyd_species_list_SLvs1.csv",
                     skip = 7)

head(spp.info)

```



## Merge

```{r}
names(dat)[3] <-"spp.code"

summary(dat$spp.code)
summary(spp.info$spp.code)


dat2 <- merge(dat, spp.info, by =)

dim(dat2)
dim(dat)

dat <- dat2


#remove some extra rows
dat <- dat[,-c(2,4,6)]
```


* Dataframe should be ~547 rows




### Data subset

Use just species capture > 3 sep years



**ISSUE**: I think this is redundant - already done previously in prior script


```{r}
# i4plus <- which(dat$tot.years.obs > 3)
# 
# dat2 <- dat[i4plus,]
# 
# length(i4plus)

```



# GLMM set up

## Load library
```{r}
library(lme4)
```


## Set up for GLMM

GLMMs work best when continous covariates are centered.

```{r}
dat$Year.cent <- with(dat,
                               scale(Year,
                                     scale = F))
```


Poisson models are often overdispered; this can be corrected by including a observation level random effect, which can be made by giving each row of data  unique ID.

See 
Using observation-level random effects to model overdispersion in count data in ecology and evolution
XA Harrison - PeerJ, 2014 - peerj.com
https://peerj.com/articles/616/

```{r}
dat$row.effect <- 1:dim(dat)[1]
```

## Order disturbance sensitivty factor

```{r}
dat$sensitivity <- factor(dat$sensitivity,
                               levels = c("L","M","H"))
```


## Order migration "status" factor

```{r}
dat$status <- factor(dat$status,
                               levels = c("res","NEO"))
```


# Overdispersion


http://glmm.wikidot.com/faq
```{r}
overdisp_fun <- function(model) {
  ## number of variance parameters in 
  ##   an n-by-n variance-covariance matrix
  vpars <- function(m) {
    nrow(m)*(nrow(m)+1)/2
  }
  model.df <- sum(sapply(VarCorr(model),vpars))+length(fixef(model))
  rdf <- nrow(model.frame(model))-model.df
  rp <- residuals(model,type="pearson")
  Pearson.chisq <- sum(rp^2)
  prat <- Pearson.chisq/rdf
  pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
  c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}
```



# Include observation level random effect


```{r}
m1.no.Loc <- glmer(spp.ann.tot ~ 
                        Year.cent +
            (Year.cent|spp.code) +
            (1|Year) +
            (1|row.effect),
data = dat,
offset = log(net.hours),
family = poisson)

summary(m1.no.Loc)
```





```{r}
dat$log.net.hours <- with(dat, log(net.hours))
m1.Loc.ranef <- lmer(spp.ann.tot/log.net.hours ~ 
                        Year.cent +
                     (1|spp.code) +
            (Year.cent|spp.code:Location) +
            (1|Year) +
            (1|Year:Location), #+
            #(1|row.effect),
data = dat#,
#offset  = log.net.hours,
#family = poisson
#
)

summary(m1.Loc.ranef)
```


# Predictions

expand.grid(
  spp.code = levels(m1.Loc.ranef@frame$spp.code),
  Location = levels(m1.Loc.ranef@frame$Location),
  Year.cent = range(m1.Loc.ranef@frame$Year.cent),
  Year = unique(m1.Loc.ranef@frame$Year)
  net.hours = 1000
)


```{r}

fake.dat <- m1.Loc.ranef@frame

summary(fake.dat)
summary(log(dat$net.hours))


#fake.dat$"(offset)" <- 1

y.hat <- predict(m1.Loc.ranef,
                 newdata =fake.dat,
                re.form = ~ (1|spp.code) + (Year.cent|spp.code:Location))


summary(y.hat)


out <- m1.Loc.ranef@frame
out$y.hat <- y.hat


summary(out$y.hat)

library(ggplot2)
library(cowplot)

out$spp.ann.tot/exp(out$`(offset)`)*1000

temp <- qplot(y = spp.ann.tot/log.net.hours,
      x = Year,
      color = Location,
      data = out) +
  geom_line(aes(y = y.hat, 
                x = Year,
                color = Location)) +
  facet_wrap(facets =  ~spp.code  ,
             scales = "free") +
  theme(legend.position="none") #+
  #geom_vline(xintercept = 2003) +
  #geom_vline(xintercept = 2002)

save_plot(temp,filename = "temp.jpeg",base_height = 10)


```







```{r}

```




```{r}
library(arm)
se.list <- se.ranef(m1.Loc.ranef)
str(se.list,1)

se.list[[2]][,"Year.cent"]
```






```{r}
ranef(m1.Loc.ranef)[2]
```












```{r}
rand.slopes3 <- glmer(spp.ann.tot ~ Year.cent +
            (Year.cent|spp.code) +
            (1|Year) +
            (1|row.effect),
data = dat,
offset = log(net.hours),
family = poisson)

summary(rand.slopes3)
```



