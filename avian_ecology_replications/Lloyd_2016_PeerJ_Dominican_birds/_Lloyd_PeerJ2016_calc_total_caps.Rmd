---
title: "Lloyd 2016 PeerJ Dominican Birds: Final prep for regression"
author: "brouwern@gmail.com"
date: "February 16, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

* This script is used to determine which species were captured to rarely to be included i the analsyis.
* The csv file produced is suitable for regression analyses
* initial file: Lloyd_PeerJ2916_cleaned_with_0s_2_7_2017.csv
* final file:   Lloyd_PeerJ2916_for_regression_2_16_2017.csv

# Load data

Load data where absences had been add
```{r}
setwd("C:/Users/lisanjie2/Dropbox/Scott_E_Aviary_Projects")

spp.ann.tot2.b <- read.csv(file = "Lloyd_PeerJ2916_cleaned_with_0s_2_7_2017.csv")
```


Check - should be zeros for "spp.ann.tot"
```{r}
summary(spp.ann.tot2.b)
```




# Process data

* I want to be able to screen out the species that were captured less frequently
* At a minimum, a species probably needs to be captured during at least 3 different years to fit an adequete regression line
* I have outlined simulations to test this assumption and need to go back to them.

## "Cast" data into wide format

* I'll use the dcast() function to reshape the data from "long format" (each row is a seperate observation) to "wide format" (all observations in a single row)
* This will also allow me to sumarize total number of captures per year


### Wide format
```{r}
head(spp.ann.tot2.b)
```


### Reshape to "long"

* I want to retation "Location" and  "Species" as variable that identify the data.
* "~ Year" means "put years into columns"
* " value.var = "spp.ann.tot" " means I'm aggregating / summarizing over the current spp.ann.tot column in the "long" data
* "fun.aggregate = sum" means "sum up all the data that is described by Location, Species, Site and Year"

```{r}
library(reshape2)

dat.cat <- dcast(data = spp.ann.tot2.b,
      formula = Location +  Species + Location ~ Year,
      value.var = "spp.ann.tot",
      fun.aggregate = sum)

```



### Long data

This show all of the ID columns and some of the year columns
```{r}
head(dat.cat[,c(1:8,dim(dat.cat)[2])])
```



## Recode data to 0/1

* I want to summarize how many years during the study a species was observed at a given site
* I'm not concerned with the number of times it was observed
* I am goign to convert the wide data to just contain 0s and 1s, then add up all the 1s


```{r}
# Make  a copy of the dataframe
## I drop the 1st 3 columns which have the IDs
dat.cat01 <- dat.cat[,-c(1:3)]


#define a function that will turns numbers to binary
## 1 = any value 1 or greater
## 0 = 0
fnxn01 <- function(x){ifelse(x>0,1,0)}


# Apply the function fnxn01() I just makde
## to the wide-format 
## dat.cat01 dataframe
## the "2" means "apply to the columns"
dat.cat01 <-  apply(dat.cat01, 2, fnxn01)


#Apply the sum() function to the rows of the data
## 1 = rows
tot.years.obs <- apply(dat.cat01, 1, sum)




```



Look at distribution of number of times a speices was observed.  Lookslike about 12 species were only observed 1 time at a given site
```{r}
#
hist(tot.years.obs)

max(tot.years.obs)

```



Add number of times observed to the identification columns

```{r}

tot.years.obs <- cbind(dat.cat[,c("Location",                                          "Species")],
               tot.years.obs)
```



Look at distribution of obsevations by Location.  PUVI has both more species captured once AND more species captured every year
```{r}
library(ggplot2)

qplot(tot.years.obs,
      geom = "histogram",
      data = tot.years.obs,
      facets = . ~ Location)

```





# Merge number of years observed w/ original data


Use dim() to check to make sure original and subsequent dataframes are same size.

```{r}
#
spp.ann.tot3 <- merge(spp.ann.tot2.b,
                      tot.years.obs)

dim(spp.ann.tot2.b)
dim(spp.ann.tot3)
summary(spp.ann.tot3)

dim(spp.ann.tot3)
```



# Subset data

Make an index for species-site combinations where species was observed 4 or more times.  Use that index to subset the data
```{r}

i.4 <- which(spp.ann.tot3$tot.years.obs > 3)

#only 28 rows get removed
length(spp.ann.tot3$tot.years.obs) - length(i.4)


spp.ann.tot4 <- spp.ann.tot3[i.4, ]
```




# Reformat "Species" column to remove any species removed from data

```{r}
#convert to charater data
spp.ann.tot4$Species <- as.character(spp.ann.tot4$Species)

#convert back to factor data
spp.ann.tot4$Species <- factor(spp.ann.tot4$Species )

summary(spp.ann.tot4$Species )

length(unique(spp.ann.tot4$Species))



```


How many species removed?: 12
```{r}
length(unique(spp.ann.tot3$Species))
length(unique(spp.ann.tot4$Species))
```




Need to drop 2 years where they sampled PUVI but not PALO
```{r}
i.drop <-which(spp.ann.tot4$Location == "PALO" &
        spp.ann.tot4$Year %in% c(2000,2001))

```



```{r}
spp.ann.tot4 <- spp.ann.tot4[-i.drop,]
```



# Save processed data
```{r}
write.csv(spp.ann.tot4,
          file = "Lloyd_PeerJ2916_for_regression_2_16_2017.csv")
```


# Plot data

## Plot regression lines for each species
```{r}
qplot(y = spp.ann.tot,
      x = Year,
      color = Species,
      shape = Location,
      data = spp.ann.tot4) +
  facet_grid(Location~., scale = "free") + 
    geom_smooth(method = "glm", se = F,
              method.args = list(family = "poisson"))
```


## log+1 transform

Because so many species have low abundance its hard to see the trends.  A log+1 transform is useful for visualization.  I then fit  lm()
```{r}


qplot(y = log(spp.ann.tot+1),
      x = Year,
      color = Species,
      shape = Location,
      data = spp.ann.tot4) +
  facet_grid(.~Location, scale = "free") + 
    geom_smooth(method = "lm", 
                se = F)
```



## Plot seperate panels for each species
```{r}
qplot(y = spp.ann.tot,
      x = Year,
      color = Species,
      shape = Location,
      data = spp.ann.tot4) +
  facet_wrap(~Species, scales = "free") + geom_smooth(method = "glm", se = F,
              method.args = list(family = "poisson"))
  
```


